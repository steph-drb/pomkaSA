<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>POMKA SA - Dashboard Ultra-Modulable</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&family=Orbitron:wght@500;900&display=swap" rel="stylesheet" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      :root {
        --bg-color: #0f172a;
        --card-bg: #1e293b;
        --accent-primary: #f43f5e;
        --accent-secondary: #3b82f6;
        --text-main: #f8fafc;
        --text-muted: #94a3b8;
        --success: #10b981;
        --danger: #ef4444;
      }

      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font-family: "Inter", sans-serif; background-color: var(--bg-color); color: var(--text-main); line-height: 1.6; padding-bottom: 50px; }
      h1, h2, h3 { font-family: "Orbitron", sans-serif; text-transform: uppercase; }
      header { background: linear-gradient(90deg, #0f172a 0%, #331e28 100%); padding: 2rem; border-bottom: 2px solid var(--accent-primary); text-align: center; }
      header h1 { font-size: 2.5rem; color: var(--accent-primary); }
      
      .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 40px; }
      .grid-full { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
      
      .card { background-color: var(--card-bg); border-radius: 12px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.05); position: relative; display: flex; flex-direction: column; min-height: 250px; }
      
      /* Titres */
      .editable-title { border-bottom: 1px solid transparent; transition: 0.3s; cursor: text; margin-bottom: 15px; width: 100%; font-size: 1.2rem; color: var(--text-main); }
      .editable-title:hover { background: rgba(255,255,255,0.03); }

      /* Liste et Items */
      ul { list-style: none; flex-grow: 1; }
      li { margin-bottom: 12px; padding-left: 10px; border-left: 3px solid var(--accent-primary); display: flex; align-items: flex-start; gap: 10px; group; }
      .item-text { flex-grow: 1; outline: none; min-height: 1.2em; }
      
      /* Boutons de suppression individuelle (sous-titres) */
      .btn-del-item { 
        color: var(--text-muted); 
        cursor: pointer; 
        font-size: 0.9rem; 
        opacity: 0; 
        transition: 0.2s;
        padding: 0 5px;
      }
      li:hover .btn-del-item { opacity: 1; color: var(--danger); }

      /* Boutons d'actions */
      .action-btns { display: flex; gap: 10px; margin-top: 15px; }
      .btn { 
        padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.7rem; font-family: 'Orbitron'; transition: 0.3s; text-transform: uppercase;
      }
      .btn-add { background: rgba(244, 63, 94, 0.1); color: var(--accent-primary); border: 1px dashed var(--accent-primary); }
      .btn-add:hover { background: var(--accent-primary); color: white; }
      .btn-del-col { background: transparent; color: var(--text-muted); border: 1px solid rgba(255,255,255,0.1); }
      .btn-del-col:hover { background: var(--danger); color: white; border-color: var(--danger); }
      .btn-main-add { background: var(--accent-secondary); color: white; border: none; font-size: 0.8rem; }

      #sync-status { font-size: 0.7rem; margin-top: 5px; color: var(--success); opacity: 0; transition: opacity 0.5s; }
    </style>
  </head>
  <body>
    <header>
      <h1>POMKA SA</h1>
      <p>Syst√®me de Management Dynamique</p>
      <div id="sync-status">‚úì Synchronis√©</div>
    </header>

    <div class="container">
      <div class="grid-full">
        <h2>1. Business Model Canvas & Strat√©gie</h2>
        <button class="btn btn-main-add" onclick="createNewColumn()">Ôºã Ajouter une colonne</button>
      </div>
      
      <div class="grid" id="main-grid">
        </div>
    </div>

    <script>
      const SUPABASE_URL = 'https://jythapadyguuktsrkjxv.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5dGhhcGFkeWd1dWt0c3Jranh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NTM3MjksImV4cCI6MjA4NDAyOTcyOX0.8pdyVotuywtI6UpCao2lCpulTwU-4U5Lf3yv35FT-Ec';
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      async function loadData() {
        const { data } = await supabaseClient.from('content').select('data').eq('id', 1).single();
        const grid = document.getElementById('main-grid');
        grid.innerHTML = '';

        if (data && data.data && data.data.columns) {
          data.data.columns.forEach(col => renderColumn(col));
        } else {
          // Setup par d√©faut
          const defaults = [
            { title: "üõí Proposition de Valeur", items: ["Acc√®s imm√©diat", "Exp√©rience Secret Club"] },
            { title: "üë• Segments Clients", items: ["√âtudiants", "VIP"] }
          ];
          defaults.forEach(col => renderColumn(col));
        }
      }

      function renderColumn(colData) {
        const grid = document.getElementById('main-grid');
        const colId = 'col-' + Date.now() + Math.random().toString(36).substr(2, 5);
        
        const card = document.createElement('div');
        card.className = 'card';
        card.id = colId;
        
        card.innerHTML = `
          <h3 class="editable-title" contenteditable="true" onblur="saveData()">${colData.title}</h3>
          <ul class="item-list"></ul>
          <div class="action-btns">
            <button class="btn btn-add" onclick="addItemToCol('${colId}')">Ôºã Ajouter</button>
            <button class="btn btn-del-col" onclick="removeColumn('${colId}')">Supprimer Colonne</button>
          </div>
        `;
        
        grid.appendChild(card);
        const ul = card.querySelector('ul');
        colData.items.forEach(itemText => renderItem(ul, itemText));
      }

      function renderItem(parentUl, text) {
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="item-text" contenteditable="true" onblur="saveData()">${text}</div>
          <div class="btn-del-item" onclick="this.parentElement.remove(); saveData();">‚úï</div>
        `;
        parentUl.appendChild(li);
      }

      function createNewColumn() {
        renderColumn({ title: "Nouveau Titre", items: ["Nouveau..."] });
        saveData();
      }

      function addItemToCol(colId) {
        const ul = document.querySelector(`#${colId} ul`);
        renderItem(ul, "Nouveau...");
        saveData();
      }

      function removeColumn(colId) {
        if(confirm("Supprimer toute la colonne ?")) {
          document.getElementById(colId).remove();
          saveData();
        }
      }

      async function saveData() {
        const syncStatus = document.getElementById('sync-status');
        syncStatus.style.opacity = 1;
        syncStatus.textContent = "‚åõ Sauvegarde...";

        const columns = [];
        document.querySelectorAll('.card').forEach(card => {
          const title = card.querySelector('.editable-title').innerText;
          const items = Array.from(card.querySelectorAll('.item-text')).map(el => el.innerText);
          columns.push({ title, items });
        });

        await supabaseClient.from('content').update({ data: { columns } }).eq('id', 1);
        
        syncStatus.textContent = "‚úì Synchronis√©";
        setTimeout(() => syncStatus.style.opacity = 0, 2000);
      }

      window.onload = loadData;
    </script>
  </body>
</html>
