<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>POMKA SA - Dashboard StratÃ©gique & OpÃ©rationnel</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&family=Orbitron:wght@500;900&display=swap" rel="stylesheet" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      :root {
        --bg-color: #0f172a;
        --card-bg: #1e293b;
        --accent-primary: #f43f5e;
        --accent-secondary: #3b82f6;
        --text-main: #f8fafc;
        --text-muted: #94a3b8;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #eab308;
      }

      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font-family: "Inter", sans-serif; background-color: var(--bg-color); color: var(--text-main); line-height: 1.6; padding-bottom: 50px; }
      h1, h2, h3 { font-family: "Orbitron", sans-serif; text-transform: uppercase; }
      header { background: linear-gradient(90deg, #0f172a 0%, #331e28 100%); padding: 2rem; border-bottom: 2px solid var(--accent-primary); text-align: center; }
      header h1 { font-size: 2.5rem; color: var(--accent-primary); }
      .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 40px; }
      .grid-full { grid-column: 1 / -1; }
      .card { background-color: var(--card-bg); border-radius: 12px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.05); position: relative; display: flex; flex-direction: column; }
      
      /* Titres Ã©ditables */
      .editable-title { border-bottom: 1px solid transparent; transition: 0.3s; cursor: text; margin-bottom: 15px; display: inline-block; width: 100%; }
      .editable-title:hover { border-bottom: 1px solid var(--accent-secondary); background: rgba(255,255,255,0.03); }

      [contenteditable="true"] { outline: none; transition: all 0.2s; border-radius: 4px; padding: 2px 5px; }
      [contenteditable="true"]:focus { background: rgba(59, 130, 246, 0.1); box-shadow: 0 0 0 2px var(--accent-secondary); }

      ul { list-style: none; margin-bottom: 10px; flex-grow: 1; }
      li { margin-bottom: 8px; padding-left: 15px; border-left: 2px solid var(--accent-primary); position: relative; }
      
      .action-btns { display: flex; gap: 10px; margin-top: auto; flex-wrap: wrap; }
      .add-item-btn { 
        background: rgba(244, 63, 94, 0.1); 
        color: var(--accent-primary); 
        border: 1px dashed var(--accent-primary); 
        padding: 5px 10px; 
        border-radius: 6px; 
        cursor: pointer; 
        font-size: 0.7rem; 
        font-family: 'Orbitron';
      }
      .del-col-btn {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        border: 1px solid var(--danger);
        padding: 5px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.7rem;
        font-family: 'Orbitron';
      }

      /* Progress & Ops */
      .progress-container { background: #000; border-radius: 20px; height: 25px; width: 100%; margin: 15px 0; overflow: hidden; border: 1px solid var(--accent-secondary); }
      .progress-bar { background: linear-gradient(90deg, var(--accent-secondary), var(--success)); height: 100%; width: 0%; transition: width 0.5s; }
      .inventory-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; background: rgba(0,0,0,0.1); padding: 5px; border-radius: 6px; }
      .inventory-text { flex-grow: 1; font-size: 0.9rem; }
      .btn-del-item { color: var(--danger); cursor: pointer; font-weight: bold; padding: 0 5px; }

      /* Inputs */
      .control-group { margin-bottom: 15px; }
      select, input[type="number"] { background: #0f172a; color: white; border: 1px solid var(--accent-primary); padding: 5px; border-radius: 4px; width: 100%; }
      input[type="range"] { width: 100%; accent-color: var(--accent-primary); }
      .val-display { float: right; color: var(--accent-primary); font-weight: bold; }
      .stat-box { text-align: center; background: rgba(0, 0, 0, 0.2); padding: 10px; border-radius: 8px; margin-top: 10px; }
      .stat-val { font-size: 1.5rem; font-family: "Orbitron"; }
      .profit { color: var(--success); }
      
      footer { text-align: center; margin-top: 50px; color: var(--text-muted); font-size: 0.8rem; }
      #sync-status { font-size: 0.7rem; margin-top: 5px; color: var(--success); opacity: 0; transition: opacity 0.5s; }
    </style>
  </head>
  <body>
    <header>
      <h1>POMKA SA</h1>
      <p>Modulable Strategy Dashboard</p>
      <div id="sync-status">âœ“ SynchronisÃ©</div>
    </header>

    <div class="container">
      
      <div class="grid" id="bmc-grid">
        <div class="grid-full"><h2>1. Business Model Canvas (Ã‰ditable)</h2></div>
        
        <div class="card" id="col-1">
          <h3 class="editable-title" contenteditable="true" onblur="saveData()" id="title-valeur">ðŸ›’ Proposition de Valeur</h3>
          <ul id="list-valeur" class="bmc-list"></ul>
          <div class="action-btns">
            <button class="add-item-btn" onclick="addNewItem('list-valeur')">ï¼‹ Ajouter</button>
            <button class="del-col-btn" onclick="deleteColumn('col-1')">Supprimer Colonne</button>
          </div>
        </div>

        <div class="card" id="col-2">
          <h3 class="editable-title" contenteditable="true" onblur="saveData()" id="title-segments">ðŸ‘¥ Segments Clients</h3>
          <ul id="list-segments" class="bmc-list"></ul>
          <div class="action-btns">
            <button class="add-item-btn" onclick="addNewItem('list-segments')">ï¼‹ Ajouter</button>
            <button class="del-col-btn" onclick="deleteColumn('col-2')">Supprimer Colonne</button>
          </div>
        </div>

        <div class="card" id="col-3">
          <h3 class="editable-title" contenteditable="true" onblur="saveData()" id="title-revenus">ðŸ’° Flux de Revenus</h3>
          <ul id="list-revenus" class="bmc-list"></ul>
          <div class="action-btns">
            <button class="add-item-btn" onclick="addNewItem('list-revenus')">ï¼‹ Ajouter</button>
            <button class="del-col-btn" onclick="deleteColumn('col-3')">Supprimer Colonne</button>
          </div>
        </div>
      </div>

      <div class="grid">
        <div class="grid-full"><h2>2. Objectifs & Logistique</h2></div>
        <div class="card">
          <h3 class="editable-title" contenteditable="true" onblur="saveData()" id="title-goal">ðŸŽ¯ Objectif Refuge</h3>
          <input type="number" id="goalInput" value="500" oninput="calculate()">
          <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
          <p id="progressText" style="text-align: center; font-weight: bold; font-size: 0.8rem;">0% financÃ©</p>
        </div>
        <div class="card">
          <h3 class="editable-title" contenteditable="true" onblur="saveData()" id="title-network">ðŸ“± RÃ©seau & Contacts</h3>
          <div class="stat-box">
            <div class="stat-val" style="color: var(--accent-secondary);" id="contactCount" contenteditable="true" onblur="saveData()">0</div>
            <div style="font-size: 0.7rem;">Contacts VIP</div>
          </div>
        </div>
        <div class="card">
          <h3 class="editable-title" contenteditable="true" onblur="saveData()" id="title-stash">ðŸ§Š Inventaire (Stash)</h3>
          <div id="inventoryContainer"></div>
          <button class="add-item-btn" onclick="addInventoryItem()">ï¼‹ Ajouter objet</button>
        </div>
      </div>

      <div class="grid">
        <div class="grid-full"><h2>3. Simulateur Financier</h2></div>
        <div class="card">
          <div class="control-group">
            <label>CoÃ»t / Vente / Ventes</label>
            <input type="range" id="costInput" min="0.5" max="10" step="0.1" value="1.50" />
            <input type="range" id="priceInput" min="2" max="20" step="0.5" value="5.00" />
            <input type="range" id="salesInput" min="0" max="300" step="5" value="50" />
          </div>
        </div>
        <div class="card">
          <div class="stat-box">
            <div>BÃ©nÃ©fice Net</div>
            <div class="stat-val profit" id="netProfit">0 CHF</div>
          </div>
        </div>
        <div class="card grid-full"><div class="chart-container"><canvas id="scenarioChart"></canvas></div></div>
      </div>
    </div>

    <footer><p>&copy; 2026 POMKA SA - Cloud Dashboard</p></footer>

    <script>
      const SUPABASE_URL = 'https://jythapadyguuktsrkjxv.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5dGhhcGFkeWd1dWt0c3Jranh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NTM3MjksImV4cCI6MjA4NDAyOTcyOX0.8pdyVotuywtI6UpCao2lCpulTwU-4U5Lf3yv35FT-Ec';
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // Charger les donnÃ©es
      async function loadData() {
        const { data } = await supabaseClient.from('content').select('data').eq('id', 1).single();
        if (data && data.data) {
          const d = data.data;
          
          // Charger les titres
          document.querySelectorAll('.editable-title').forEach(t => {
            if(d[t.id]) t.innerText = d[t.id];
          });

          // Charger les listes BMC
          ['list-valeur', 'list-segments', 'list-revenus'].forEach(id => {
            const listEl = document.getElementById(id);
            if (d[id]) {
              listEl.innerHTML = '';
              d[id].forEach(text => createLi(listEl, text));
            }
          });

          // Cacher les colonnes supprimÃ©es
          if(d.deletedCols) d.deletedCols.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.display = 'none';
          });

          if(d.contacts) document.getElementById('contactCount').innerText = d.contacts;
          if(d.goal) document.getElementById('goalInput').value = d.goal;
          
          const container = document.getElementById('inventoryContainer');
          container.innerHTML = '';
          if(d.dynamicInventory) {
            d.dynamicInventory.forEach(item => renderInventoryItem(item.text, item.checked));
          }
        }
        initChart();
        calculate();
      }

      // Sauvegarde
      async function saveData() {
        const syncStatus = document.getElementById('sync-status');
        syncStatus.style.opacity = 1; syncStatus.textContent = "âŒ› Sauvegarde...";
        
        const deleted = [];
        document.querySelectorAll('.card').forEach(c => {
          if(c.style.display === 'none') deleted.push(c.id);
        });

        let contentToSave = {
          contacts: document.getElementById('contactCount').innerText,
          goal: document.getElementById('goalInput').value,
          deletedCols: deleted,
          dynamicInventory: Array.from(document.querySelectorAll('.inventory-item')).map(el => ({
            text: el.querySelector('.inventory-text').innerText,
            checked: el.querySelector('input').checked
          }))
        };
        
        // Titres et listes
        document.querySelectorAll('.editable-title').forEach(t => contentToSave[t.id] = t.innerText);
        document.querySelectorAll('.bmc-list').forEach(l => contentToSave[l.id] = Array.from(l.querySelectorAll('li')).map(li => li.innerHTML));

        await supabaseClient.from('content').update({ data: contentToSave }).eq('id', 1);
        syncStatus.textContent = "âœ“ SynchronisÃ©";
        setTimeout(() => syncStatus.style.opacity = 0, 2000);
      }

      function deleteColumn(id) {
        if(confirm("Supprimer cette colonne du dashboard ?")) {
          document.getElementById(id).style.display = 'none';
          saveData();
        }
      }

      function createLi(parentUl, text) {
        const li = document.createElement('li');
        li.contentEditable = "true";
        li.innerHTML = text;
        li.addEventListener('blur', saveData);
        parentUl.appendChild(li);
      }

      function addNewItem(id) { createLi(document.getElementById(id), "Nouveau..."); saveData(); }

      function renderInventoryItem(text, checked) {
        const div = document.createElement('div');
        div.className = 'inventory-item';
        div.innerHTML = `<input type="checkbox" ${checked ? 'checked' : ''} onchange="saveData()"><div class="inventory-text" contenteditable="true" onblur="saveData()">${text}</div><div class="btn-del-item" onclick="this.parentElement.remove(); saveData();">Ã—</div>`;
        document.getElementById('inventoryContainer').appendChild(div);
      }

      function addInventoryItem() { renderInventoryItem("Nouvel objet...", false); saveData(); }

      function calculate() {
        const cost = parseFloat(document.getElementById("costInput").value);
        const price = parseFloat(document.getElementById("priceInput").value);
        const sales = parseInt(document.getElementById("salesInput").value);
        const goal = parseFloat(document.getElementById("goalInput").value) || 1;
        const profit = (price - cost) * sales;
        document.getElementById("netProfit").textContent = profit.toFixed(2) + " CHF";
        const percent = Math.min(Math.max((profit / goal) * 100, 0), 100);
        document.getElementById("progressBar").style.width = percent + "%";
        document.getElementById("progressText").textContent = Math.round(percent) + "% financÃ©";
        if (window.scenarioChart) {
          window.scenarioChart.data.datasets[0].data = [profit * 0.5, profit, profit * 1.3];
          window.scenarioChart.update();
        }
      }

      function initChart() {
        const ctx = document.getElementById("scenarioChart").getContext("2d");
        window.scenarioChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["Pessimiste", "RÃ©aliste", "Optimiste"],
            datasets: [{ label: "Profit (CHF)", data: [0, 0, 0], backgroundColor: ["#ef4444", "#3b82f6", "#10b981"] }]
          },
          options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
      }

      window.onload = loadData;
      document.querySelectorAll('input').forEach(i => i.addEventListener('input', calculate));
    </script>
  </body>
</html>
