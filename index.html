<!DOCTYPE html>
<!-- saved from url=(0061)file:///C:/A-project%202k26/pomka%20site,%20plus%20carte.html -->
<html lang="fr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POMKA SA - Dashboard StratÃ©gique</title>
    <link href="./POMKA SA - Dashboard StratÃ©gique_files/css2" rel="stylesheet">
    
    <script src="./POMKA SA - Dashboard StratÃ©gique_files/supabase-js@2"></script>
    <script src="./POMKA SA - Dashboard StratÃ©gique_files/chart.js.download"></script>
    
    <link rel="stylesheet" href="./POMKA SA - Dashboard StratÃ©gique_files/leaflet.css">
    <script src="./POMKA SA - Dashboard StratÃ©gique_files/leaflet.js.download"></script>
    <link rel="stylesheet" href="./POMKA SA - Dashboard StratÃ©gique_files/Control.Geocoder.css">
    <script src="./POMKA SA - Dashboard StratÃ©gique_files/Control.Geocoder.js.download"></script>

    <style>
      :root {
        --bg-color: #0f172a; --card-bg: #1e293b; --accent-primary: #f43f5e;
        --accent-secondary: #3b82f6; --text-main: #f8fafc; --text-muted: #94a3b8;
        --success: #10b981; --danger: #ef4444; --map-accent: #00f2fe;
      }

      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font-family: "Inter", sans-serif; background-color: var(--bg-color); color: var(--text-main); line-height: 1.6; padding-bottom: 50px; }
      h1, h2, h3 { font-family: "Orbitron", sans-serif; text-transform: uppercase; }
      
      header { background: linear-gradient(90deg, #0f172a 0%, #331e28 100%); padding: 2rem; border-bottom: 2px solid var(--accent-primary); text-align: center; }
      header h1 { font-size: 2.5rem; color: var(--accent-primary); }
      #sync-status { font-size: 0.7rem; margin-top: 5px; color: var(--success); opacity: 0; transition: opacity 0.5s; }

      .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 40px; }
      .grid-full { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
      
      .card { background-color: var(--card-bg); border-radius: 12px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.05); position: relative; display: flex; flex-direction: column; }
      
      /* BMC & Listes */
      .editable-title { border-bottom: 1px solid transparent; transition: 0.3s; cursor: text; margin-bottom: 15px; width: 100%; font-size: 1.2rem; }
      .editable-title:hover { background: rgba(255,255,255,0.03); border-bottom-color: var(--accent-secondary); }
      ul { list-style: none; flex-grow: 1; margin-bottom: 10px; }
      li { margin-bottom: 8px; padding-left: 10px; border-left: 3px solid var(--accent-primary); display: flex; align-items: center; justify-content: space-between; }
      .item-text { flex-grow: 1; outline: none; }
      .btn-del-item { color: var(--text-muted); cursor: pointer; font-size: 0.8rem; opacity: 0; padding: 0 5px; }
      li:hover .btn-del-item { opacity: 1; color: var(--danger); }

      /* Logistique & Simulateur */
      .progress-container { background: #000; border-radius: 20px; height: 20px; width: 100%; margin: 10px 0; overflow: hidden; border: 1px solid var(--accent-secondary); }
      .progress-bar { background: linear-gradient(90deg, var(--accent-secondary), var(--success)); height: 100%; width: 0%; transition: width 0.5s; }
      .inventory-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 6px; }
      .slider-group { margin-bottom: 15px; }
      .slider-label { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px; color: var(--text-muted); }
      .slider-label span { color: var(--accent-secondary); font-weight: bold; }
      input[type="range"] { width: 100%; accent-color: var(--accent-primary); cursor: pointer; }
      .stat-box { text-align: center; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
      .stat-val { font-size: 1.2rem; font-family: "Orbitron"; color: var(--success); }

      .btn { padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.7rem; font-family: 'Orbitron'; transition: 0.3s; text-transform: uppercase; border: 1px solid transparent; }
      .btn-add { background: rgba(244, 63, 94, 0.1); color: var(--accent-primary); border: 1px dashed var(--accent-primary); margin-top: 10px; }
      .btn-main-add { background: var(--accent-secondary); color: white; border: none; }

      /* --- STYLE CARTE --- */
      .map-section-wrapper { display: flex; height: 600px; background: var(--card-bg); border-radius: 24px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
      .map-sidebar { width: 300px; background: #1e293b; border-right: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; }
      #zoneList { padding: 15px; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
      .zone-card { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 12px; border-left: 5px solid; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
      .zone-card:hover { transform: translateX(5px); }
      .map-container-inner { flex-grow: 1; position: relative; }
      #map { height: 100%; width: 100%; }
      .dark-mode-map #map { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%) !important; }
      .dark-mode-map .leaflet-marker-icon, .dark-mode-map .leaflet-control-geocoder, .dark-mode-map .leaflet-popup-content-wrapper { filter: invert(100%) hue-rotate(-180deg) !important; }
      .map-config { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(30, 41, 59, 0.9); padding: 10px 20px; border-radius: 50px; display: flex; gap: 15px; align-items: center; border: 1px solid rgba(255,255,255,0.1); }
      .fixed-dot { width: 10px; height: 10px; background: white; border: 2px solid var(--map-accent); border-radius: 50%; box-shadow: 0 0 10px var(--map-accent); }
    </style>
  </head>

  <body>
    <header>
      <h1>POMKA SA</h1>
      <p>Management Dashboard v4.1 - Profitability &amp; Strategy</p>
      <div id="sync-status">âœ“ DonnÃ©es synchronisÃ©es</div>
    </header>

    <div class="container">
      <div class="grid-full">
        <h2>1. Business Model Canvas</h2>
        <button class="btn btn-main-add" onclick="createNewColumn()">ï¼‹ Colonne</button>
      </div>
      <div id="bmc-grid" class="grid"><div class="card" id="col-dl33hg22o"><h3 class="editable-title" contenteditable="true" onblur="saveAll()">PROPOSITION&nbsp; VALEUR</h3><ul class="item-list"><li><div class="item-text" contenteditable="true" onblur="saveAll()">AccÃ¨s immÃ©diat (0 attente).</div><div class="btn-del-item" onclick="this.parentElement.remove(); saveAll();">âœ•</div></li><li><div class="item-text" contenteditable="true" onblur="saveAll()">Prix "Ami" (&lt; Prix Bar).</div><div class="btn-del-item" onclick="this.parentElement.remove(); saveAll();">âœ•</div></li><li><div class="item-text" contenteditable="true" onblur="saveAll()">accÃ¨s a nos fÃªtes</div><div class="btn-del-item" onclick="this.parentElement.remove(); saveAll();">âœ•</div></li><li><div class="item-text" contenteditable="true" onblur="saveAll()">ExpÃ©rience "Secret Club".</div><div class="btn-del-item" onclick="this.parentElement.remove(); saveAll();">âœ•</div></li></ul><div style="display:flex; gap:10px"><button class="btn btn-add" onclick="addItemToCol(&#39;col-dl33hg22o&#39;)">ï¼‹</button><button class="btn" onclick="removeColumn(&#39;col-dl33hg22o&#39;)" style="color:var(--text-muted)">âœ•</button></div></div><div class="card" id="col-ymbt4fz15"><h3 class="editable-title" contenteditable="true" onblur="saveAll()">LES PERSONNA&nbsp;</h3><ul class="item-list"><li><div class="item-text" contenteditable="true" onblur="saveAll()">Le receptif a notre projet: Il trouve que ce qu'on propose est une bonne idÃ©e et veut nous soutenir</div><div class="btn-del-item" onclick="this.parentElement.remove(); saveAll();">âœ•</div></li><li><div class="item-text" contenteditable="true" onblur="saveAll()">L'Impatient: DÃ©teste les queues.</div><div class="btn-del-item" onclick="this.parentElement.remove(); saveAll();">âœ•</div></li></ul><div style="display:flex; gap:10px"><button class="btn btn-add" onclick="addItemToCol(&#39;col-ymbt4fz15&#39;)">ï¼‹</button><button class="btn" onclick="removeColumn(&#39;col-ymbt4fz15&#39;)" style="color:var(--text-muted)">âœ•</button></div></div><div class="card" id="col-5fhu8tm0q"><h3 class="editable-title" contenteditable="true" onblur="saveAll()">FLUX DE REVENUS</h3><ul class="item-list"><li><div class="item-text" contenteditable="true" onblur="saveAll()">Marge sur "Remboursements" de cocktail.</div><div class="btn-del-item" onclick="this.parentElement.remove(); saveAll();">âœ•</div></li><li><div class="item-text" contenteditable="true" onblur="saveAll()">entrÃ©e des fÃªtes</div><div class="btn-del-item" onclick="this.parentElement.remove(); saveAll();">âœ•</div></li><li><div class="item-text" contenteditable="true" onblur="saveAll()">dons</div><div class="btn-del-item" onclick="this.parentElement.remove(); saveAll();">âœ•</div></li></ul><div style="display:flex; gap:10px"><button class="btn btn-add" onclick="addItemToCol(&#39;col-5fhu8tm0q&#39;)">ï¼‹</button><button class="btn" onclick="removeColumn(&#39;col-5fhu8tm0q&#39;)" style="color:var(--text-muted)">âœ•</button></div></div></div>

      <div class="grid-full"><h2>2. Logistique &amp; Objectifs</h2></div>
      <div class="grid">
        <div class="card">
          <h3 class="editable-title" contenteditable="true" id="title-goal" onblur="saveAll()">ðŸŽ¯ OBJECTIF REFUGE</h3>
          <input type="number" id="goalInput" value="500" oninput="calculate()" style="background:#0f172a; color:white; border:1px solid var(--accent-primary); padding:5px; width:100%; border-radius:4px;">
          <div class="progress-container"><div id="progressBar" class="progress-bar" style="width: 10%;"></div></div>
          <p id="progressText" style="text-align: center; font-size: 0.8rem;">10% de l'objectif</p>
        </div>
        <div class="card">
          <h3 class="editable-title" contenteditable="true" id="title-network" onblur="saveAll()">ðŸ“± RÃ‰SEAU VIP</h3>
          <div class="stat-box">
            <div id="contactCount" class="stat-val" contenteditable="true" onblur="saveAll()" style="color: var(--accent-secondary); font-size: 2rem;">@steph.drb<br>@margo.jar</div>
            <div class="stat-label">Contacts Actifs</div>
          </div>
        </div>
        <div class="card">
          <h3 class="editable-title" contenteditable="true" id="title-stash" onblur="saveAll()">ðŸ§Š INVENTAIRE</h3>
          <div id="inventoryContainer"><div class="inventory-item"><input type="checkbox" checked="" onchange="saveAll()"><div contenteditable="true" class="item-text" onblur="saveAll()">vodka</div><div class="btn-del-item" onclick="this.parentElement.remove(); saveAll();" style="opacity:1">âœ•</div></div><div class="inventory-item"><input type="checkbox" onchange="saveAll()"><div contenteditable="true" class="item-text" onblur="saveAll()">Objet...</div><div class="btn-del-item" onclick="this.parentElement.remove(); saveAll();" style="opacity:1">âœ•</div></div><div class="inventory-item"><input type="checkbox" onchange="saveAll()"><div contenteditable="true" class="item-text" onblur="saveAll()">Objet...</div><div class="btn-del-item" onclick="this.parentElement.remove(); saveAll();" style="opacity:1">âœ•</div></div></div>
          <button class="btn btn-add" onclick="addInventoryItem()">ï¼‹ Objet</button>
        </div>
      </div>

      <div class="grid-full"><h2>3. Simulateur de RentabilitÃ©</h2></div>
      <div class="grid">
        <div class="card">
          <div class="slider-group"><div class="slider-label">CoÃ»t Verre : <span id="val-cost">0.50</span> CHF</div><input type="range" id="costInput" min="0" max="20" step="0.1" value="1.5" oninput="calculate()"></div>
          <div class="slider-group"><div class="slider-label">Prix Vente : <span id="val-price">3.00</span> CHF</div><input type="range" id="priceInput" min="0" max="50" step="0.5" value="5" oninput="calculate()"></div>
          <div class="slider-group"><div class="slider-label">Ventes (Objectif) : <span id="val-sales">20</span></div><input type="range" id="salesInput" min="0" max="1000" step="10" value="50" oninput="calculate()"></div>
          <div class="slider-group"><div class="slider-label">DurÃ©e Shift (h) : <span id="val-hours">4</span> h</div><input type="range" id="hoursInput" min="1" max="24" step="1" value="4" oninput="calculate()"></div>
          <div class="slider-group"><div class="slider-label">Vitesse (min/verre) : <span id="val-mpv">10</span> min</div><input type="range" id="mpvInput" min="0.5" max="15" step="0.5" value="3" oninput="calculate()"></div>
        </div>
        <div class="card">
          <div class="stat-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div class="stat-box"><div class="stat-label">BÃ©nÃ©fice Net</div><div class="stat-val" id="netProfit">50.00 CHF</div></div>
            <div class="stat-box"><div class="stat-label">Marge</div><div class="stat-val" id="marginPercent" style="color:var(--accent-secondary)">83.3%</div></div>
            <div class="stat-box" title="Utilisation de la capacitÃ© de production"><div class="stat-label">% CapacitÃ© UtilisÃ©</div><div class="stat-val" id="usageRate" style="color:var(--accent-primary)">83%</div></div>
            <div class="stat-box"><div class="stat-label">BÃ©nÃ©fice / Heure</div><div class="stat-val" id="profitPerHour" style="color:var(--success)">12.50 CHF</div></div>
          </div>
          <canvas id="scenarioChart" style="max-height: 150px; margin-top: 15px; display: block; box-sizing: border-box; height: 150px; width: 433.5px;" width="812" height="281"></canvas>
        </div>
      </div>

      <div class="grid-full"><h2>4. Cartes des FÃªtes &amp; StratÃ©gie Terrain</h2></div>
      <div class="map-section-wrapper dark-mode-map" id="mapWrapper">
        <div class="map-sidebar">
          <div style="padding:15px; border-bottom:1px solid rgba(255,255,255,0.1);"><h3>Zones</h3></div>
          <div id="zoneList"><p id="emptyMsg" style="text-align: center; color: rgb(102, 102, 102); font-size: 0.8rem; margin-top: 20px; display: none;">Cliquez sur la carte</p><div class="zone-card" id="card-179" style="border-left-color: rgb(0, 242, 254);"><div onclick="map.setView(map._layers[179].getLatLng(), 17)" style="cursor:pointer"><b>fiesta</b><br><span style="font-size:0.7rem">50m</span></div><button onclick="deleteZone(179, 182)" style="background:none; border:none; color:red; cursor:pointer; font-size:1.2rem;">âœ•</button></div></div>
        </div>
        <div class="map-container-inner">
          <div class="map-config">
            <button class="btn" onclick="toggleMapTheme()" style="background:#333; border-radius:50%; width:30px; height:30px; padding:0;">ðŸŒ™</button>
            <label style="font-size:0.7rem;">Rayon (m):</label>
            <input type="number" id="mapRadiusInput" value="50" style="width:45px; background:var(--bg-color); color:white; border:1px solid var(--map-accent);">
            <input type="color" id="mapColorPicker" value="#00f2fe">
          </div>
          <div id="map" class="leaflet-container leaflet-touch leaflet-retina leaflet-fade-anim leaflet-grab leaflet-touch-drag leaflet-touch-zoom" tabindex="0" style="position: relative;"><div class="leaflet-pane leaflet-map-pane" style="transform: translate3d(0px, 0px, 0px);"><div class="leaflet-pane leaflet-tile-pane"><div class="leaflet-layer " style="z-index: 1; opacity: 1;"><div class="leaflet-tile-container leaflet-zoom-animated" style="z-index: 17; transform: translate3d(104px, 107px, 0px) scale(0.5);"></div><div class="leaflet-tile-container leaflet-zoom-animated" style="z-index: 18; transform: translate3d(104px, 107px, 0px) scale(1);"><img alt="" src="./POMKA SA - Dashboard StratÃ©gique_files/23026.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(47px, -11px, 0px); opacity: 1;"><img alt="" src="./POMKA SA - Dashboard StratÃ©gique_files/23026(1).png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(303px, -11px, 0px); opacity: 1;"><img alt="" src="./POMKA SA - Dashboard StratÃ©gique_files/23027.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(47px, 245px, 0px); opacity: 1;"><img alt="" src="./POMKA SA - Dashboard StratÃ©gique_files/23027(1).png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(303px, 245px, 0px); opacity: 1;"><img alt="" src="./POMKA SA - Dashboard StratÃ©gique_files/23025.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(47px, -267px, 0px); opacity: 1;"><img alt="" src="./POMKA SA - Dashboard StratÃ©gique_files/23025(1).png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(303px, -267px, 0px); opacity: 1;"><img alt="" src="./POMKA SA - Dashboard StratÃ©gique_files/23026(2).png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-209px, -11px, 0px); opacity: 1;"><img alt="" src="./POMKA SA - Dashboard StratÃ©gique_files/23026(3).png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(559px, -11px, 0px); opacity: 1;"><img alt="" src="./POMKA SA - Dashboard StratÃ©gique_files/23025(2).png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-209px, -267px, 0px); opacity: 1;"><img alt="" src="./POMKA SA - Dashboard StratÃ©gique_files/23025(3).png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(559px, -267px, 0px); opacity: 1;"><img alt="" src="./POMKA SA - Dashboard StratÃ©gique_files/23027(2).png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-209px, 245px, 0px); opacity: 1;"><img alt="" src="./POMKA SA - Dashboard StratÃ©gique_files/23027(3).png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(559px, 245px, 0px); opacity: 1;"></div></div></div><div class="leaflet-pane leaflet-overlay-pane"><svg pointer-events="none" class="leaflet-zoom-animated" width="802" height="719" viewBox="-67 -60 802 719" style="transform: translate3d(-67px, -60px, 0px);"><g><path class="leaflet-interactive" stroke="#00f2fe" stroke-opacity="1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="#00f2fe" fill-opacity="0.3" fill-rule="evenodd" d="M239.45288017764688,256.8470467142761a31,31 0 1,0 62,0 a31,31 0 1,0 -62,0 "></path></g></svg></div><div class="leaflet-pane leaflet-shadow-pane"></div><div class="leaflet-pane leaflet-marker-pane"><div class="leaflet-marker-icon fixed-dot leaflet-zoom-animated" tabindex="0" role="button" style="margin-left: -5px; margin-top: -5px; width: 10px; height: 10px; transform: translate3d(270px, 257px, 0px); z-index: 257;"></div></div><div class="leaflet-pane leaflet-tooltip-pane"></div><div class="leaflet-pane leaflet-popup-pane"></div><div class="leaflet-proxy leaflet-zoom-animated" style="transform: translate3d(8.75692e+06px, 5.89486e+06px, 0px) scale(32768);"></div></div><div class="leaflet-control-container"><div class="leaflet-top leaflet-left"></div><div class="leaflet-top leaflet-right"><div class="leaflet-control-geocoder leaflet-bar leaflet-control"><button class="leaflet-control-geocoder-icon" type="button" aria-label="Initiate a new search">&nbsp;</button><div class="leaflet-control-geocoder-form"><input class="" type="search" placeholder="Chercher ville..."></div><div class="leaflet-control-geocoder-form-no-error">Nothing found.</div><ul class="leaflet-control-geocoder-alternatives leaflet-control-geocoder-alternatives-minimized"></ul></div></div><div class="leaflet-bottom leaflet-left"></div><div class="leaflet-bottom leaflet-right"><div class="leaflet-control-zoom leaflet-bar leaflet-control"><a class="leaflet-control-zoom-in" href="file:///C:/A-project%202k26/pomka%20site,%20plus%20carte.html#" title="Zoom in" role="button" aria-label="Zoom in" aria-disabled="false"><span aria-hidden="true">+</span></a><a class="leaflet-control-zoom-out" href="file:///C:/A-project%202k26/pomka%20site,%20plus%20carte.html#" title="Zoom out" role="button" aria-label="Zoom out" aria-disabled="false"><span aria-hidden="true">âˆ’</span></a></div><div class="leaflet-control-attribution leaflet-control"><a href="https://leafletjs.com/" title="A JavaScript library for interactive maps"><svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="12" height="8" viewBox="0 0 12 8" class="leaflet-attribution-flag"><path fill="#4C7BE1" d="M0 0h12v4H0z"></path><path fill="#FFD500" d="M0 4h12v3H0z"></path><path fill="#E0BC00" d="M0 7h12v1H0z"></path></svg> Leaflet</a></div></div></div></div>
        </div>
      </div>
    </div>

    <script>
      const SUPABASE_URL = 'https://jythapadyguuktsrkjxv.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5dGhhcGFkeWd1dWt0c3Jranh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NTM3MjksImV4cCI6MjA4NDAyOTcyOX0.8pdyVotuywtI6UpCao2lCpulTwU-4U5Lf3yv35FT-Ec';
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      let chart;

      // --- LOGIQUE DASHBOARD ---
      async function loadData() {
        const { data } = await supabaseClient.from('content').select('data').eq('id', 1).single();
        if (data && data.data) {
          const d = data.data;
          const bmcGrid = document.getElementById('bmc-grid');
          bmcGrid.innerHTML = '';
          if (d.columns) d.columns.forEach(col => renderColumn(col));
          if (d.goal) document.getElementById('goalInput').value = d.goal;
          if (d.contacts) document.getElementById('contactCount').innerText = d.contacts;
          if (d.logisticsTitles) {
            Object.keys(d.logisticsTitles).forEach(id => { if (document.getElementById(id)) document.getElementById(id).innerText = d.logisticsTitles[id]; });
          }
          const invContainer = document.getElementById('inventoryContainer');
          invContainer.innerHTML = '';
          if (d.inventory) d.inventory.forEach(item => renderInventoryItem(item.text, item.checked));
        }
        initChart(); calculate();
      }

      function renderColumn(colData) {
        const grid = document.getElementById('bmc-grid');
        const colId = 'col-' + Math.random().toString(36).substr(2, 9);
        const card = document.createElement('div');
        card.className = 'card'; card.id = colId;
        card.innerHTML = `<h3 class="editable-title" contenteditable="true" onblur="saveAll()">${colData.title}</h3><ul class="item-list"></ul><div style="display:flex; gap:10px"><button class="btn btn-add" onclick="addItemToCol('${colId}')">ï¼‹</button><button class="btn" onclick="removeColumn('${colId}')" style="color:var(--text-muted)">âœ•</button></div>`;
        grid.appendChild(card);
        const ul = card.querySelector('ul');
        colData.items.forEach(text => renderItem(ul, text));
      }

      function renderItem(parentUl, text) {
        const li = document.createElement('li');
        li.innerHTML = `<div class="item-text" contenteditable="true" onblur="saveAll()">${text}</div><div class="btn-del-item" onclick="this.parentElement.remove(); saveAll();">âœ•</div>`;
        parentUl.appendChild(li);
      }

      function addItemToCol(id) { renderItem(document.querySelector(`#${id} ul`), "Nouveau..."); saveAll(); }
      function createNewColumn() { renderColumn({ title: "Nouveau", items: ["..."] }); saveAll(); }
      function removeColumn(id) { if (confirm("Supprimer ?")) { document.getElementById(id).remove(); saveAll(); } }

      function renderInventoryItem(text, checked) {
        const div = document.createElement('div');
        div.className = 'inventory-item';
        div.innerHTML = `<input type="checkbox" ${checked ? 'checked' : ''} onchange="saveAll()"><div contenteditable="true" class="item-text" onblur="saveAll()">${text}</div><div class="btn-del-item" onclick="this.parentElement.remove(); saveAll();" style="opacity:1">âœ•</div>`;
        document.getElementById('inventoryContainer').appendChild(div);
      }
      function addInventoryItem() { renderInventoryItem("Objet...", false); saveAll(); }

      function calculate() {
        const cost = parseFloat(document.getElementById("costInput").value);
        const price = parseFloat(document.getElementById("priceInput").value);
        const sales = parseInt(document.getElementById("salesInput").value);
        const hours = parseFloat(document.getElementById("hoursInput").value) || 1;
        const mpv = parseFloat(document.getElementById("mpvInput").value) || 1;
        const target = parseFloat(document.getElementById("goalInput").value) || 1;

        document.getElementById("val-cost").innerText = cost.toFixed(2);
        document.getElementById("val-price").innerText = price.toFixed(2);
        document.getElementById("val-sales").innerText = sales;
        document.getElementById("val-hours").innerText = hours;
        document.getElementById("val-mpv").innerText = mpv;

        const profit = (price - cost) * sales;
        const margin = price > 0 ? (profit / (price * sales)) * 100 : 0;
        
        // --- NOUVELLES LOGIQUES ---
        const totalCapacity = (hours * 60) / mpv; // Max de verres prÃ©parables
        const usageRate = (sales / totalCapacity) * 100; // % d'occupation du staff
        const profitHour = profit / hours; // BÃ©nÃ©fice horaire

        document.getElementById("netProfit").textContent = profit.toFixed(2) + " CHF";
        document.getElementById("marginPercent").textContent = margin.toFixed(1) + "%";
        document.getElementById("usageRate").textContent = Math.round(usageRate) + "%";
        document.getElementById("profitPerHour").textContent = profitHour.toFixed(2) + " CHF";

        const percent = Math.min((profit / target) * 100, 100);
        document.getElementById("progressBar").style.width = percent + "%";
        document.getElementById("progressText").textContent = Math.round(percent) + "% de l'objectif";

        if(chart) { chart.data.datasets[0].data = [cost * sales, profit > 0 ? profit : 0]; chart.update(); }
      }

      function initChart() {
        const ctx = document.getElementById("scenarioChart").getContext("2d");
        chart = new Chart(ctx, { type: "doughnut", data: { labels: ["CoÃ»ts", "BÃ©nÃ©fice"], datasets: [{ data: [0, 0], backgroundColor: ["#ef4444", "#10b981"], borderWidth: 0 }] }, options: { plugins: { legend: { display: false } }, maintainAspectRatio: false } });
      }

      async function saveAll() {
        const sync = document.getElementById('sync-status'); sync.style.opacity = 1;
        const data = {
          columns: Array.from(document.querySelectorAll('#bmc-grid .card')).map(c => ({ title: c.querySelector('.editable-title').innerText, items: Array.from(c.querySelectorAll('.item-text')).map(i => i.innerText) })),
          inventory: Array.from(document.querySelectorAll('.inventory-item')).map(e => ({ text: e.querySelector('.item-text').innerText, checked: e.querySelector('input').checked })),
          goal: document.getElementById('goalInput').value,
          contacts: document.getElementById('contactCount').innerText,
          logisticsTitles: { 'title-goal': document.getElementById('title-goal').innerText, 'title-network': document.getElementById('title-network').innerText, 'title-stash': document.getElementById('title-stash').innerText }
        };
        await supabaseClient.from('content').update({ data }).eq('id', 1);
        setTimeout(() => (sync.style.opacity = 0), 1000);
      }

      // --- LOGIQUE CARTE ---
      var map = L.map('map', { zoomControl: false }).setView([46.8182, 8.2275], 8);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      L.control.zoom({ position: 'bottomright' }).addTo(map);

      function toggleMapTheme() { document.getElementById('mapWrapper').classList.toggle('dark-mode-map'); }

      map.on('click', function(e) {
        const name = prompt("Lieu/Festival :"); if(!name) return;
        const r = parseInt(document.getElementById('mapRadiusInput').value);
        const c = document.getElementById('mapColorPicker').value;
        const circle = L.circle(e.latlng, { radius: r, color: c, fillColor: c, fillOpacity: 0.3, weight: 2 }).addTo(map);
        const dot = L.marker(e.latlng, { icon: L.divIcon({ className:'fixed-dot', iconSize:[10,10], iconAnchor:[5,5] }), interactive: false }).addTo(map);
        addZoneToList(L.stamp(circle), L.stamp(dot), name, r, c);
      });

      function addZoneToList(cId, dId, name, r, c) {
        document.getElementById('emptyMsg').style.display = 'none';
        const card = document.createElement('div');
        card.className = 'zone-card'; card.id = `card-${cId}`; card.style.borderLeftColor = c;
        card.innerHTML = `<div onclick="map.setView(map._layers[${cId}].getLatLng(), 17)" style="cursor:pointer"><b>${name}</b><br><span style="font-size:0.7rem">${r}m</span></div><button onclick="deleteZone(${cId}, ${dId})" style="background:none; border:none; color:red; cursor:pointer; font-size:1.2rem;">âœ•</button>`;
        document.getElementById('zoneList').appendChild(card);
      }

      function deleteZone(cId, dId) { 
        if(map._layers[cId]) map.removeLayer(map._layers[cId]); 
        if(map._layers[dId]) map.removeLayer(map._layers[dId]); 
        const card = document.getElementById(`card-${cId}`);
        if(card) card.remove();
        if(document.getElementById('zoneList').children.length === 1) document.getElementById('emptyMsg').style.display = 'block';
      }

      L.Control.geocoder({ defaultMarkGeocode: false, placeholder: "Chercher ville..." }).on('markgeocode', (e) => map.setView(e.geocode.center, 16)).addTo(map);

      window.onload = loadData;
    </script>
  
</body></html>
